<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurazione Dashcam</title>
</head>
<body>
  <h1>Configurazione Dashcam</h1>
  
  <form id="configForm">
    <!-- Sezione Immagine -->
    <fieldset>
      <legend>Impostazioni Immagine</legend>
      <label>Qualit√† JPEG (%): 
        <input type="number" id="imageQuality" min="1" max="100" required>
      </label><br>
      
      <label>Risoluzione:
        <select id="imageResolution" required>
          <option value="small">Piccola (640x480)</option>
          <option value="medium">Media (1280x720)</option>
          <option value="large">Grande (1920x1080)</option>
        </select>
      </label><br>
      
      <label>Intervallo cattura (s): 
        <input type="number" id="captureInterval" min="1" required>
      </label>
    </fieldset>

    <!-- Sezione FTP -->
    <fieldset>
      <legend>Configurazione FTP</legend>
      <label>Host: <input type="text" id="ftpHost" required></label><br>
      <label>User: <input type="text" id="ftpUser" required></label><br>
      <label>Password: <input type="password" id="ftpPassword" required></label>
    </fieldset>

    <!-- Sezione GPS -->
    <fieldset>
      <legend>Impostazioni GPS</legend>
      <label>Intervallo invio dati (s): 
        <input type="number" id="gpsInterval" min="1" required>
      </label>
    </fieldset>

    <!-- Sezione WiFi -->
    <fieldset>
      <legend>Configurazione WiFi</legend>
      <label>SSID: <input type="text" id="wifiSsid" required></label><br>
      <label>Password: <input type="password" id="wifiPassword" required></label>
    </fieldset>

    <button type="submit">Salva Configurazione</button>
  </form>

  <script>
    const serviceUUID = 'fff0';
    const configCharUUID = 'fff2';
    let configCharacteristic;

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'RPi-Controller' }],
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        configCharacteristic = await service.getCharacteristic(configCharUUID);

        // Leggi la configurazione attuale
        const configData = await configCharacteristic.readValue();
        const configText = new TextDecoder().decode(configData);
        populateForm(configText);

      } catch (error) {
        console.error('Errore connessione:', error);
      }
    }

    function populateForm(configText) {
      const config = Object.fromEntries(
        configText.split('\n').map(line => line.split('='))
      );

      document.getElementById('imageQuality').value = config.image_quality;
      document.getElementById('imageResolution').value = config.image_resolution;
      document.getElementById('captureInterval').value = config.capture_interval;
      document.getElementById('ftpHost').value = config.ftp_host;
      document.getElementById('ftpUser').value = config.ftp_user;
      document.getElementById('ftpPassword').value = config.ftp_password;
      document.getElementById('gpsInterval').value = config.gps_interval;
      document.getElementById('wifiSsid').value = config.wifi_ssid;
      document.getElementById('wifiPassword').value = config.wifi_password;
    }

    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const config = {
        image_quality: document.getElementById('imageQuality').value,
        image_resolution: document.getElementById('imageResolution').value,
        capture_interval: document.getElementById('captureInterval').value,
        ftp_host: document.getElementById('ftpHost').value,
        ftp_user: document.getElementById('ftpUser').value,
        ftp_password: document.getElementById('ftpPassword').value,
        gps_interval: document.getElementById('gpsInterval').value,
        wifi_ssid: document.getElementById('wifiSsid').value,
        wifi_password: document.getElementById('wifiPassword').value
      };

      const configText = Object.entries(config)
        .map(([key, value]) => `${key}=${value}`)
        .join('\n');

      await configCharacteristic.writeValue(new TextEncoder().encode(configText));
      alert('Configurazione salvata con successo!');
    });

    connectBluetooth();
  </script>
</body>
</html>
